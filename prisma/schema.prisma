generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── USERS & ROLES ───────────────────────────────────────────────────────────

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String
  password  String   // bcrypt hash (for prototype; future: OAuth)
  roleId    String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  role                  Role                  @relation(fields: [roleId], references: [id])
  attendanceRecords     AttendanceRecord[]
  leaveRequests         LeaveRequest[]
  concerns              Concern[]
  sodexoIssues          SodexoIssue[]
  accessChangeRequests  AccessChangeRequest[] @relation("Requester")
  accessChangeDecisions AccessChangeRequest[] @relation("Reviewer")
  auditLogs             AuditLog[]
  materials             Material[]

  @@index([email])
  @@index([roleId])
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique // DEVELOPER, PROGRAM_OFFICE, FACULTY, TA, STUDENT, COCO, SODEXO, EXAM_CELL
  displayName String
  isAdmin     Boolean  @default(false)
  createdAt   DateTime @default(now())

  users       User[]
  permissions RolePermission[]
}

model RolePermission {
  id        String  @id @default(uuid())
  roleId    String
  tileKey   String  // e.g., "onboard_batch", "attendance_hub", "timetable"
  canAccess Boolean @default(false)
  canWrite  Boolean @default(false)

  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, tileKey])
  @@index([roleId])
  @@index([tileKey])
}

// ─── ACADEMIC STRUCTURE ──────────────────────────────────────────────────────

model Batch {
  id           String   @id @default(uuid())
  name         String   // e.g., "PGDM 25-27"
  programName  String
  academicYear String
  status       String   @default("ACTIVE") // ACTIVE, ARCHIVED
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  divisions Division[]
  courses   Course[]
}

model Division {
  id        String   @id @default(uuid())
  batchId   String
  name      String   // e.g., "Division A", "Marketing Specialization"
  type      String   // CORE, SPECIALIZATION, CAD, OTHER
  createdAt DateTime @default(now())

  batch            Batch              @relation(fields: [batchId], references: [id], onDelete: Cascade)
  timetableEvents  TimetableEvent[]
  attendanceRecords AttendanceRecord[]

  @@index([batchId])
}

model Course {
  id          String   @id @default(uuid())
  batchId     String
  name        String
  code        String
  description String?
  createdAt   DateTime @default(now())

  batch     Batch      @relation(fields: [batchId], references: [id], onDelete: Cascade)
  materials Material[]

  @@index([batchId])
}

// ─── TIMETABLE ───────────────────────────────────────────────────────────────

model TimetableEvent {
  id         String   @id @default(uuid())
  divisionId String
  title      String
  date       DateTime
  startTime  String   // "09:00"
  endTime    String   // "10:30"
  location   String?
  eventType  String   @default("LECTURE") // LECTURE, LAB, EXAM, OTHER
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  division          Division           @relation(fields: [divisionId], references: [id], onDelete: Cascade)
  attendanceRecords AttendanceRecord[]

  @@index([divisionId])
  @@index([date])
}

// ─── ATTENDANCE ──────────────────────────────────────────────────────────────

model AttendanceRecord {
  id               String   @id @default(uuid())
  userId           String
  timetableEventId String
  divisionId       String
  status           String   @default("PRESENT") // PRESENT, ABSENT, LATE, EXCUSED
  markedAt         DateTime @default(now())
  source           String   @default("MANUAL") // MANUAL, BIOMETRIC, UPLOAD

  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  timetableEvent TimetableEvent @relation(fields: [timetableEventId], references: [id], onDelete: Cascade)
  division       Division       @relation(fields: [divisionId], references: [id], onDelete: Cascade)

  @@unique([userId, timetableEventId])
  @@index([userId])
  @@index([timetableEventId])
  @@index([divisionId])
}

// ─── LEAVE REQUESTS ──────────────────────────────────────────────────────────

model LeaveRequest {
  id          String   @id @default(uuid())
  userId      String
  purpose     String
  startDate   DateTime
  endDate     DateTime
  status      String   @default("PENDING") // PENDING, APPROVED, REJECTED
  attachments String?  // JSON array of file paths
  comments    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
}

// ─── CONCERNS ────────────────────────────────────────────────────────────────

model Concern {
  id        String   @id @default(uuid())
  userId    String
  subject   String
  body      String
  category  String   @default("GENERAL") // GENERAL, ACADEMIC, INFRASTRUCTURE, OTHER
  status    String   @default("OPEN")    // OPEN, IN_PROGRESS, RESOLVED, CLOSED
  comments  String?  // JSON for internal comments
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
}

// ─── MATERIALS ───────────────────────────────────────────────────────────────

model Material {
  id           String   @id @default(uuid())
  courseId      String
  uploadedById String
  title        String
  description  String?
  category     String   @default("LECTURE_NOTES") // LECTURE_NOTES, SLIDES, READING, ASSIGNMENT, OTHER
  fileUrl      String?
  fileName     String?
  sessionNumber Int?
  createdAt    DateTime @default(now())

  course     Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  uploadedBy User   @relation(fields: [uploadedById], references: [id])

  @@index([courseId])
}

// ─── SODEXO SUPPORT ──────────────────────────────────────────────────────────

model SodexoIssue {
  id          String   @id @default(uuid())
  reportedById String
  location    String
  description String
  priority    String   @default("MEDIUM") // LOW, MEDIUM, HIGH, URGENT
  status      String   @default("OPEN")   // OPEN, IN_PROGRESS, RESOLVED
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  reportedBy User @relation(fields: [reportedById], references: [id])

  @@index([status])
}

// ─── ACCESS CHANGE REQUESTS ──────────────────────────────────────────────────

model AccessChangeRequest {
  id             String   @id @default(uuid())
  requesterId    String
  currentRoleId  String
  requestedRoleId String
  reason         String
  status         String   @default("PENDING") // PENDING, APPROVED, REJECTED
  reviewerId     String?
  reviewComment  String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  requester User  @relation("Requester", fields: [requesterId], references: [id])
  reviewer  User? @relation("Reviewer", fields: [reviewerId], references: [id])

  @@index([requesterId])
  @@index([status])
}

// ─── AUDIT LOG ───────────────────────────────────────────────────────────────

model AuditLog {
  id         String   @id @default(uuid())
  userId     String
  action     String   // e.g., "ROLE_CHANGE", "BATCH_CREATE", "ATTENDANCE_UPLOAD"
  entityType String   // e.g., "User", "Batch", "AttendanceRecord"
  entityId   String
  details    String?  // JSON with before/after state
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entityType])
  @@index([createdAt])
}
